#====================
# ターミナル / True Color
#====================

# tmux-256color (italics + 256色対応。screen-256color より優れている)
set -g default-terminal "tmux-256color"

# True 24-bit color パススルー
set -as terminal-features ",xterm-256color:RGB"

# OSC52 クリップボードパススルー（SSH越しのコピーにも対応）
set -g set-clipboard on

# Neovim の OSC52 クリップボードを tmux 越しで動かす
set -g allow-passthrough on

# Neovim の FocusGained / FocusLost イベントを有効化
set -g focus-events on

#====================
# 入力 / レイテンシ
#====================

# escape-time を短縮（デフォルト 500ms → 10ms）
set -sg escape-time 10

# マウス操作を有効化（クリックでペイン選択、ドラッグでリサイズ、スクロール）
set -g mouse on

#====================
# Prefix キー
#====================

unbind C-b
set-option -g prefix C-j
bind-key C-j send-prefix

#====================
# セッション / ウィンドウ
#====================

# スクロールバックを拡大（デフォルト 2000 行）
set -g history-limit 50000

# ウィンドウ・ペイン番号を 1 始まりに
set -g base-index 1
setw -g pane-base-index 1

# ウィンドウを閉じたとき番号を自動整理
set -g renumber-windows on

# コマンド実行時にウィンドウ名を自動変更しない
set-option -g allow-rename off

#====================
# vi キーバインド
#====================

set-window-option -g mode-keys vi
bind Space copy-mode
bind p paste-buffer

# コピーモード（reattach-to-user-namespace 不要、modern macOS では pbcopy 直接使用）
bind-key -T copy-mode-vi v     send-keys -X begin-selection
bind-key -T copy-mode-vi V     send-keys -X select-line
bind-key -T copy-mode-vi C-v   send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y     send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "pbcopy"

#====================
# ペイン操作
#====================

# 分割時にカレントディレクトリを引き継ぐ
bind-key - split-window -v -c "#{pane_current_path}"
bind-key \\ split-window -h -c "#{pane_current_path}"

# 新規ウィンドウもカレントディレクトリで開く
bind-key c new-window -c "#{pane_current_path}"

# vi 風ペイン移動
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# vi 風ペインリサイズ
bind -r C-h resize-pane -L 5
bind -r C-l resize-pane -R 5
bind -r C-j resize-pane -D 5
bind -r C-k resize-pane -U 5

# ズーム切り替え
bind -r z resize-pane -Z

#====================
# Claude Code 連携
#====================

# C-j C-a : ディレクトリごとの永続 Claude popup
#   - 初回: claude セッションを起動
#   - 再度: 同じ会話に戻る（popup を閉じても claude は終了しない）
bind-key C-a run-shell '\
  SESSION="claude-$(echo #{pane_current_path} | md5 | cut -c1-8)"; \
  tmux has-session -t "$SESSION" 2>/dev/null || \
    tmux new-session -d -s "$SESSION" -c "#{pane_current_path}" "claude"; \
  tmux display-popup \
    -d "#{pane_current_path}" \
    -w 90% -h 90% -E \
    "tmux attach-session -t $SESSION"'

# C-j C-x : 現在ディレクトリの Claude セッションを終了
bind-key C-x run-shell '\
  SESSION="claude-$(echo #{pane_current_path} | md5 | cut -c1-8)"; \
  tmux kill-session -t "$SESSION" 2>/dev/null && \
  tmux display-message "Killed Claude session: $SESSION"'

# C-j C-s : 汎用スクラッチ popup（調査・確認作業など）
bind-key C-s display-popup -d "#{pane_current_path}" -w 80% -h 80% -E "$SHELL"

#====================
# ステータスバー
#====================

set-option -g status-interval 1
set-option -g status-position top
set-option -g status-justify centre

set-option -g status-left-length  40
set-option -g status-right-length 90

# 全体の背景・文字色（Tokyo Night 系）
set-option -g status-style "bg=#1e2030,fg=#c8d3f5"

# 左: セッション名（prefix 押下中は色が変わる）
set-option -g status-left \
  "#[fg=#82aaff,bold]#{?client_prefix,#[fg=#ff966c],}[#S] "

# 右: git ブランチ（cat .git/HEAD で高速取得）+ ディレクトリ名 + 時刻
set-option -g status-right \
  "#[fg=#636da6]#([ -f #{pane_current_path}/.git/HEAD ] && sed 's|ref: refs/heads/||' #{pane_current_path}/.git/HEAD || echo '') \
#[fg=#4a5173]| #[fg=#c8d3f5]#{b:pane_current_path} \
#[fg=#4a5173]| #[fg=#c8d3f5]%m/%d %H:%M"

# 非アクティブウィンドウ
set-window-option -g window-status-format \
  "#[fg=#636da6] #I:#W#{?window_zoomed_flag, [Z],} "

# アクティブウィンドウ（ズーム中は [Z] 表示）
set-window-option -g window-status-current-format \
  "#[fg=#82aaff,bold,bg=#2d3f76] #I:#W#{?window_zoomed_flag, [Z],} #[default]"

set-window-option -g window-status-separator ""

# アクティビティ検知
set-window-option -g monitor-activity on
set-option -g visual-activity off
set-window-option -g window-status-activity-style "fg=#ff966c"
